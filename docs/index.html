<!DOCTYPE html>
<!-- https://stackoverflow.com/questions/42720488/d3-v4-drag-line-chart-with-x-and-y-axes -->
<div id="legend" style="float: right">
    <span style="background-color:#009933">&nbsp;&nbsp;&nbsp;&nbsp;</span> Supply Curve
    <span style="background-color:#A00000">&nbsp;&nbsp;&nbsp;&nbsp;</span> Demand Curve
    <span style="background-color:black; border-radius:50%">&nbsp;&nbsp;&nbsp;&nbsp;</span> Equilibrium Point
</div>
<svg width="800" height="500"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

    
let supply_points = [[10, 10], [90, 90]];
let demand_points = [[10,90], [90, 10]];
let points = demand_points.concat(supply_points);
    
var x = d3.scaleLinear()
    .rangeRound([0, width]);

var y = d3.scaleLinear()
    .rangeRound([height, 0]);

var xAxis = d3.axisBottom(x),
    yAxis = d3.axisLeft(y);

var supply_line = d3.line()
    .x(function(d) { return x(d[0]); })
    .y(function(d) { return y(d[1]); });
var demand_line = d3.line()
    .x(function(d) { return x(d[0]); })
    .y(function(d) { return y(d[1]); });
    
let sdrag = d3.drag()
        .on('start', dragstarted)
        .on('drag', sdragged)
        .on('end', dragended);
let ddrag = d3.drag()
        .on('start', dragstarted)
        .on('drag', ddragged)
        .on('end', dragended);
let sshift = d3.drag()
                .on('start', dragstarted)
                .on('drag', sshifted)
                .on('end', dragended);
let dshift = d3.drag()
                .on('start', dragstarted)
                .on('drag', dshifted)
                .on('end', dragended);
    
svg.append('rect')
    .attr('class', 'zoom')
    .attr('cursor', 'move')
    .attr('fill', 'none')
    .attr('pointer-events', 'all')
    .attr('width', width)
    .attr('height', height)
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

 var focus = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
let range_ = [[0,0], [100, 100]];
x.domain(d3.extent(range_, function(d) { return d[0]; }));
y.domain(d3.extent(range_, function(d) { return d[1]; }));

let demand_path = focus.append("path")
    .datum(demand_points)
        .attr("id", "demand")
    .attr("fill", "none")
    .attr("stroke", "#A00000")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 3.0)
    .attr("d", demand_line)
        .call(dshift);

let supply_path = focus.append("path")
    .datum(supply_points)
        .attr("id", "supply")
    .attr("fill", "none")
    .attr("stroke", "#009933")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 3.0)
    .attr("d", supply_line)
        .call(sshift);

let supply_circles = focus.selectAll('#supply_circles')
    .data(supply_points)
    .enter()
    .append('circle')
        .attr('class', 'supply')
    .attr('r', 10.0)
    .attr('cx', function(d) { return x(d[0]);  })
    .attr('cy', function(d) { return y(d[1]); })
    .style('cursor', 'pointer')
    .style('fill', '#009933');

supply_circles.call(sdrag);

let demand_circles = focus.selectAll('#demand_circles')
    .data(demand_points)
    .enter()
    .append('circle')
        .attr('class', 'demand')
    .attr('r', 10.0)
    .attr('cx', function(d) { return x(d[0]);  })
    .attr('cy', function(d) { return y(d[1]); })
    .style('cursor', 'pointer')
    .style('fill', '#A00000');

demand_circles.call(ddrag);

focus.append('g')
    .attr('class', 'axis axis--x')
    .attr('transform', 'translate(0,' + height + ')')
    .call(xAxis);
    
focus.append('g')
    .attr('class', 'axis axis--y')
    .call(yAxis);
    
focus.append("text")
    .attr("x", (width / 2))             
    .attr("y", 0)
    .attr("text-anchor", "middle")  
    .style("font-size", "24px") 
    .text("Supply and Demand Graph");

focus.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height + margin.top + 5) + ")")
      .style("text-anchor", "middle")
      .text("Quantity");

focus.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Price");

let horizontal = focus.append("line")          // attach a line
    .style("stroke", "black")  // colour the line
    .attr("x1", x(0))     // x position of the first end of the line
    .attr("y1", y(50))      // y position of the first end of the line
    .attr("x2", x(50))     // x position of the second end of the line
    .attr("y2", y(50));

let vertical = focus.append("line")
    .style("stroke", "black")  // colour the line
    .attr("x1", x(50))     // x position of the first end of the line
    .attr("y1", y(50))      // y position of the first end of the line
    .attr("x2", x(50))     // x position of the second end of the line
    .attr("y2", height);  

let eq_point = focus.append('circle')
        .attr('class', 'demand')
    .attr('r', 10.0)
    .attr('cx', function(d) { return x(find_intersection(supply_points, demand_points)[0]);  })
    .attr('cy', function(d) { return y(find_intersection(supply_points, demand_points)[1]); })
    .style('cursor', 'pointer')
    .style('fill', 'black');

let last_x;
function dragstarted(d) {
    d3.select(this).raise().classed('active', true);
        last_x = x.invert(d3.event.x);
}

function sdragged(d) {
    d[1] = y.invert(d3.event.y);
    d3.select(this)
        .attr('cx', x(d[0]))
        .attr('cy', y(d[1]))
    supply_path.attr('d', supply_line);
        update_equilibrium(supply_points, demand_points);
}
    
function ddragged(d) {
    d[1] = y.invert(d3.event.y);
    d3.select(this)
        .attr('cx', x(d[0]))
        .attr('cy', y(d[1]))
    demand_path.attr('d', demand_line);
        update_equilibrium(supply_points, demand_points);
}

function sshifted(l) {
    supply_circles
        .each(function(d, i) {
        let cx = d[0];
        let difference = x.invert(d3.event.x) - last_x;
        d3.select(this)
            .attr('cx', x(cx + difference));
        l[i][0] = (cx + difference);
        supply_path.attr('d', supply_line);
    });
    last_x = x.invert(d3.event.x);
    update_equilibrium(supply_points, demand_points);
}
    
function dshifted(l) {
    demand_circles
        .each(function(d, i) {
        let cx = d[0];
        let difference = x.invert(d3.event.x) - last_x;
        d3.select(this)
            .attr('cx', x(cx + difference));
        l[i][0] = (cx + difference);
        demand_path.attr('d', demand_line);
    });
    last_x = x.invert(d3.event.x);
    update_equilibrium(supply_points, demand_points);
}
    
function dragended(d) {
    d3.select(this).classed('active', false);
}

function find_line(point_a, point_b) {
    let slope = (point_b[1] - point_a[1])/(point_b[0] - point_a[0]);
    let y_intercept = point_a[1] - (slope * point_a[0]);
    return [slope, y_intercept];
}
    
function find_intersection(s_points, d_points) {
    s_line = find_line(s_points[0], s_points[1]);
    d_line = find_line(d_points[0], d_points[1]);
    let x = (d_line[1] - s_line[1])/(s_line[0] - d_line[0]);
    let y = x * d_line[0] + d_line[1];
    return [x, y];
}

function update_equilibrium(s_points, d_points) {
    let intersection = find_intersection(s_points, d_points);
    eq_point.attr("cx", x(intersection[0]));
    eq_point.attr("cy", y(intersection[1]));
    horizontal.attr("y1", y(intersection[1]));
    horizontal.attr("y2", y(intersection[1]));
    horizontal.attr("x2", x(intersection[0]));
    vertical.attr("x1", x(intersection[0]));
    vertical.attr("x2", x(intersection[0]));
    vertical.attr("y1", y(intersection[1]));
}
</script>
